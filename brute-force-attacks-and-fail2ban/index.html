<!doctype html><html lang=en-us><head><title>Brute force attacks and fail2ban // A fractal spectrum of tales</title><meta charset=utf-8><meta name=generator content="Hugo 0.107.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Marcello Seri"><meta name=description content="Free thoughts of a geeky mathematician"><meta http-equiv=permissions-policy content="interest-cohort=()"><link rel=stylesheet href=https://www.mseri.me/css/main.min.4e2016cf62779480fbe7ba44c261abc7b3a9744838af7268702179daa31e0716.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Brute force attacks and fail2ban"><meta name=twitter:description content="Even a nearly unkown server like mine receives every day a number of brute force attacks. Usually I have an instance of fail2ban monitoring the logs of all my services and readily banning the attackers after few attempts.
Not tonight&mldr;
Let&rsquo;s move a step backwards. What is fail2ban and how does it work?
Reaching out the home page of the software you can read
Fail2ban scans log files and bans IPs that show the malicious signs - too many password failures, seeking for exploits, etc."><meta property="og:title" content="Brute force attacks and fail2ban"><meta property="og:description" content="Even a nearly unkown server like mine receives every day a number of brute force attacks. Usually I have an instance of fail2ban monitoring the logs of all my services and readily banning the attackers after few attempts.
Not tonight&mldr;
Let&rsquo;s move a step backwards. What is fail2ban and how does it work?
Reaching out the home page of the software you can read
Fail2ban scans log files and bans IPs that show the malicious signs - too many password failures, seeking for exploits, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://www.mseri.me/brute-force-attacks-and-fail2ban/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2013-12-12T15:00:07+00:00"><meta property="article:modified_time" content="2013-12-12T15:01:37+00:00"></head><body><header class=app-header><a href=https://www.mseri.me><img class=app-header-avatar src=/images/gauss_logo.png alt="Marcello Seri"></a><h1>A fractal spectrum of tales</h1><p>Free thoughts of a geeky mathematician</p><div class=app-header-social><a target=_blank href=https://github.com/mseri rel="noreferrer noopener"><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a target=_blank href=https://mathstodon.xyz/@mseri rel="noreferrer noopener"><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-mastodon"><title>mastodon</title><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18.648 15.254C16.832 17.017 12 16.88 12 16.88a18.262 18.262.0 01-3.288-.256c1.127 1.985 4.12 2.81 8.982 2.475-1.945 2.013-13.598 5.257-13.668-7.636L4 10.309c0-3.036.023-4.115 1.352-5.633C7.023 2.766 12 3.01 12 3.01s4.977-.243 6.648 1.667C19.977 6.195 20 7.274 20 10.31s-.456 4.074-1.352 4.944z"/><path d="M12 11.204V8.278C12 7.02 11.105 6 10 6S8 7.02 8 8.278V13m4-4.722C12 7.02 12.895 6 14 6s2 1.02 2 2.278V13"/></svg></a><a target=_blank href=https://twitter.com/marcelloseri rel="noreferrer noopener"><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a target=_blank href=https://academic.mseri.me rel="noreferrer noopener"><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-award"><title>award</title><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Brute force attacks and fail2ban</h1><div class=post-meta><div><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Dec 12, 2013</div><div><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>3 min read</div><div><svg xmlns="https://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg></div></div></header><div class=post-content><p>Even a nearly unkown server like mine receives every day a number of brute force attacks. Usually I have an instance of <code>fail2ban</code> monitoring the logs of all my services and readily banning the attackers after few attempts.</p><p>Not tonight&mldr;</p><p>Let&rsquo;s move a step backwards. What is <code>fail2ban</code> and how does it work?</p><p>Reaching out the <a href=https://www.fail2ban.org>home page</a> of the software you can read</p><blockquote><p>Fail2ban scans log files and bans IPs that show the malicious signs - too many password failures, seeking for exploits, etc. Generally Fail2Ban then used to update firewall rules to reject the IP addresses for a specified amount of time, although any arbitrary other action <em>(e.g. sending an email, or ejecting CD-ROM tray)</em> could also be configured. Out of the box Fail2Ban comes with filters for various services <em>(apache, curier, ssh, etc)</em>.</p></blockquote><p>Now that you know what we are talking about, I can tell you how fail2ban does it job. It starts a process in background (a <a href=https://en.wikipedia.org/wiki/Daemon_(computing)>daemon</a> that monitors the logs of your systems, each time something is logged it filters it using <a href=https://en.wikipedia.org/wiki/Regular_expression>regular expressions</a>, this filtering process identifies potential malicious hosts and, depending on your configuration, bans them for a limited/unlimited amount of time creating ad hoc firewall rules.</p><p>On my ubuntu server 13.04 I had to touch very few settings and add very few rules, almost all the ones that come with the default installation are working and are setted up properly. You cannot believe how many attacks I receive daily (mainly to ssh or the webserver). I wonder how much bandwith big services can waste due to these assholes&mldr;</p><p>Anyhow, the problem arised with the mail service. My mail server use <a href=https://www.dovecot.org>dovecot</a> to provide imap services, and <a href=https://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer>sasl</a> for authentication. Both of them requiring <a href=https://it.wikipedia.org/wiki/Transport_Layer_Security>TLS</a>. <em>I will not go into the details of the configuration, if you want to do something close you could use <a href=https://sealedabstract.com/code/nsa-proof-your-e-mail-in-2-hours/>NSA-proof your e-mail in 2 hours</a> as a starting point.</em></p><p>Apparently the filter that I was using for sasl had some problems: tonight I&rsquo;ve got a brute force attack (luckily with no consequences) and this morning my logwatch report was flooded by failed authentication attempts, all from the same ip. Fail2ban was definitely not doing its job properly.</p><p>A check on it is pretty easy to do. It is enough to run</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>    fail2ban-regex /var/log/mail.log /etc/fail2ban/filter.d/sasl.conf
</span></span></code></pre></div><p>to see if the filters contained in <code>/etc/fail2ban/filter.d/sasl.conf</code> are identifying anything in the logs. Despite <code>mail.log</code> was filled by lines of the form</p><pre><code>Dec 11 03:23:44 ____ postfix/smtpd[12734]: warning: unknown[___.___.___.___]: SASL LOGIN authentication failed: Connection lost to authentication server
Dec 11 03:23:44 ____ postfix/smtpd[12735]: warning: hostname kursejifjalet.com does not resolve to address ___.___.___.___: Name or service not known
</code></pre><p>I got a negative answer. Apparently, when I first setted up my configuration I probably slightly changed the filter (or I had an older version???) with a broken regexp. Anyhow the attack exposed the problem, and the fix is pretty simple. It was enough to modify the filter line in <code>/etc/fail2ban/filter.d/sasl.conf</code> with</p><pre><code>failregex = (?i): warning: [-._\w]+\[&lt;HOST&gt;\]: SASL LOGIN authentication failed(: [A-Za-z0-9+/ ]*)?$
</code></pre><p>and reload <code>fail2ban</code> to fix the issue.</p><hr><p><strong>UPDATE</strong>: apparently <a href="https://www.howtoforge.com/forums/showthread.php?t=51349">I am not the only one having had this problem</a> but it seems to be fixed on both debian and ubuntu server, so I really think that I had done something to the default regexp.</p><p>Anyway if you happen to have the same problem, I suggest you to use the filter rule suggested on the link above (it is more generic and not adapted to a particular setting):</p><pre><code>failregex = (?i): warning: [-._\w]+\[&lt;HOST&gt;\]: SASL (?:LOGIN|PLAIN|(?:CRAM|DIGEST)-MD5) authentication failed(: [A-Za-z0-9+/ ]*)?$
</code></pre></div><div class=post-footer></div></article></main></body></html>