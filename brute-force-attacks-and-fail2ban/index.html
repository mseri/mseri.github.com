<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html" charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <meta name="description" content="Tales of a Fractal Spectrum, ">

        <link rel="alternate" href="http://www.mseri.me/feed/atom.xml" type="application/atom+xml" title="Tales of a Fractal Spectrum Atom Feed"/>
        <link rel="alternate" href="http://www.mseri.me/feed/rss.xml" type="application/rss+xml" title="Tales of a Fractal Spectrum RSS Feed"/>

        <title>Brute force attacks and fail2ban - Tales of a Fractal Spectrum</title>



    <meta property="og:type" content="article" />
    <meta property="og:title" content="Brute force attacks and fail2ban" />
    <meta property="og:description" content="Even a nearly unkown server like mine receives every day a number of brute force attacks. Usually I have an instance of fail2ban monitoring the logs of all my services and readily banning the attackers after few attempts. Not tonight... Let's move a step backwards. What is fail2ban and ..." />

        <link rel="shortcut icon" href="http://www.mseri.me/images/gauss_logo.png" />

    <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Open+Sans:700,400" />
    <link rel="stylesheet" href="http://www.mseri.me/theme/css/style-min.css">
    <!--<link rel="stylesheet" href="http://www.mseri.me/theme/css/pygments.css">-->

</head>
<body itemscope itemtype="http://schema.org/WebPage">
    <div class="pure-g-r" id="layout">
        <div class="sidebar pure-u">
            <header class="header">
                <hgroup>
                        <a id="blog-logo" href="http://www.mseri.me"><img src="http://www.mseri.me/images/gauss_logo.png" alt="Blog Logo" /></a>
                    <h1 itemprop="name" class="blog-title"><a href="http://www.mseri.me">Tales of a Fractal Spectrum</a></h1>
                        <h2 itemprop="description" class="blog-description">Free thoughts of a geeky mathematician</h2>
                </hgroup>
<nav class="nav">
  <ul class="social-list">
<li class="social-item"><a class="subscribe icon-twitter" href="http://www.twitter.com/marcelloseri" target="_blank"></a></li>&nbsp;<li class="social-item"><a class="subscribe icon-facebook" href="http://www.facebook.com/marcello.seri" target="_blank"></a></li>&nbsp;<li class="social-item"><a class="subscribe icon-google-plus" href="http://plus.google.com/+MarcelloSeri" target="_blank" rel="publisher"></a></li>&nbsp;<li class="social-item"><a class="subscribe icon-github" href="http://www.github.com/mseri" target="_blank"></a></li>&nbsp;    <li class="social-item">&nbsp;</li>
    <li class="social-item"><a class="subscribe icon-feed" href="http://www.mseri.me/feed/rss.xml" target="_blank"></a></li>
</ul>
</nav>
            </header>
            <footer class="footer">
                <section class="copyright">&copy; 2013--2015 <a itemscope="copyrightHolder" href="http://www.mseri.me">Tales of a Fractal Spectrum</a></section>
                <section class="poweredby">Proudly published with Pelican on GitHub Pages.</section> 
                <section class="theme"><a href="https://github.com/mseri/purity" target="_blank">Purity</a> is built with <a href="http://purecss.io" target="_blank">PureCSS</a>.</section>
            </footer>
            
        </div>
        <div class="pure-u-1 container">
            
<main class="content" role="main" id="top-post">
        <div class="back">
            <a href="http://www.mseri.me">&larr;  back to the home page</a>
        </div>

    <article itemscope itemtype="http://schema.org/Article" class="post purity_post">

        <header class="post-header">
            <h2 itemprop="name" class="post-title big">Brute force attacks and fail2ban</h2>
            <p class="post-meta">Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">Marcello Seri</span></span> the <time itemprop="datePublished" datetime="12 Dec 2013">12 Dec 2013</time> - <span class="post-tagline"> under                                 <a class="post-category" href="http://www.mseri.me/tag/fix.html">fix</a>,                                 <a class="post-category" href="http://www.mseri.me/tag/regexp.html">regexp</a>,                                 <a class="post-category" href="http://www.mseri.me/tag/fail2ban.html">fail2ban</a>,                                 <a class="post-category" href="http://www.mseri.me/tag/brute-force.html">brute force</a>. </span></p>
        </header>

        <section class="post-content">

        <div class="post-share-box">
            <section class="share">
                <h3>Share this post</h3>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.mseri.me/brute-force-attacks-and-fail2ban/"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-twitter" href="http://twitter.com/share?text=Brute force attacks and fail2ban&url=http://www.mseri.me/brute-force-attacks-and-fail2ban/"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://www.mseri.me/brute-force-attacks-and-fail2ban/"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>
        </div>

        <div itemprop="articleBody">
            <p>Even a nearly unkown server like mine receives every day a number of brute force attacks. Usually I have an instance of <code>fail2ban</code> monitoring the logs of all my services and readily banning the attackers after few attempts.</p>
<p>Not tonight... </p>
<p>Let's move a step backwards. What is <code>fail2ban</code> and how does it work?</p>
<p>Reaching out the <a href="http://www.fail2ban.org">home page</a> of the software you can read</p>
<blockquote>
<p>Fail2ban scans log files and bans IPs that show the malicious signs - too many password failures, seeking for exploits, etc. Generally Fail2Ban then used to update firewall rules to reject the IP addresses for a specified amount of time, although any arbitrary other action <em>(e.g. sending an email, or ejecting CD-ROM tray)</em> could also be configured. Out of the box Fail2Ban comes with filters for various services <em>(apache, curier, ssh, etc)</em>.</p>
</blockquote>
<p>Now that you know what we are talking about, I can tell you how fail2ban does it job. It starts a process in background (a <a href="http://en.wikipedia.org/wiki/Daemon&amp;#95;(computing)&quot; target=&quot;&amp;#95;blank">daemon</a>) that monitors the logs of your systems, each time something is logged it filters it using <a href="http://en.wikipedia.org/wiki/Regular_expression">regular expressions</a>, this filtering process identifies potential malicious hosts and, depending on your configuration, bans them for a limited/unlimited amount of time creating ad hoc firewall rules.</p>
<p>On my ubuntu server 13.04 I had to touch very few settings and add very few rules, almost all the ones that come with the default installation are working and are setted up properly. You cannot believe how many attacks I receive daily (mainly to ssh or the webserver). I wonder how much bandwith big services can waste due to these assholes...</p>
<p>Anyhow, the problem arised with the mail service. My mail server use <a href="http://www.dovecot.org">dovecot</a> to provide imap services, and <a href="http://en.wikipedia.org/wiki/Simple_Authentication_and_Security_Layer">sasl</a> for authentication. Both of them requiring <a href="http://it.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>. <em>I will not go into the details of the configuration, if you want to do something close you could use <a href="http://sealedabstract.com/code/nsa-proof-your-e-mail-in-2-hours/">NSA-proof your e-mail in 2 hours</a> as a starting point.</em></p>
<p>Apparently the filter that I was using for sasl had some problems: tonight I've got a brute force attack (luckily with no consequences) and this morning my logwatch report was flooded by failed authentication attempts, all from the same ip. Fail2ban was definitely not doing its job properly.</p>
<p>A check on it is pretty easy to do. It is enough to run</p>
<div class="highlight"><pre>fail2ban-regex /var/log/mail.log /etc/fail2ban/filter.d/sasl.conf
</pre></div>


<p>to see if the filters contained in <code>/etc/fail2ban/filter.d/sasl.conf</code> are identifying anything in the logs. Despite <code>mail.log</code> was filled by lines of the form</p>
<div class="highlight"><pre>Dec 11 03:23:44 ____ postfix/smtpd[12734]: warning: unknown[___.___.___.___]: SASL LOGIN authentication failed: Connection lost to authentication server
Dec 11 03:23:44 ____ postfix/smtpd[12735]: warning: hostname kursejifjalet.com does not resolve to address ___.___.___.___: Name or service not known
</pre></div>


<p>I got a negative answer. Apparently, when I first setted up my configuration I probably slightly changed the filter (or I had an older version???) with a broken regexp. Anyhow the attack exposed the problem, and the fix is pretty simple. It was enough to modify the filter line in <code>/etc/fail2ban/filter.d/sasl.conf</code> with </p>
<div class="highlight"><pre>failregex = (?i): warning: [-._\w]+\[&lt;HOST&gt;\]: SASL LOGIN authentication failed(: [A-Za-z0-9+/ ]*)?$
</pre></div>


<p>and reload <code>fail2ban</code> to fix the issue.</p>
<hr />
<p><strong>UPDATE</strong>: apparently <a href="http://www.howtoforge.com/forums/showthread.php?t=51349">I am not the only one having had this problem</a> but it seems to be fixed on both debian and ubuntu server, so I really think that I had done something to the default regexp.</p>
<p>Anyway if you happen to have the same problem, I suggest you to use the filter rule suggested on the link above (it is more generic and not adapted to a particular setting):</p>
<div class="highlight"><pre>failregex = (?i): warning: [-._\w]+\[&lt;HOST&gt;\]: SASL (?:LOGIN|PLAIN|(?:CRAM|DIGEST)-MD5) authentication failed(: [A-Za-z0-9+/ ]*)?$
</pre></div>
        </div>
        
        </section>

<section class="post-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE UNCOMMENTING THE THEME * * */
    var disqus_shortname = 'talesofafractalspectrum'; // required: replace example with your forum shortname
    // make sure to use the post.id as an identifier, 
    //otherwise disqus will use the pages url per default, 
    //which might be problematic...
    var disqus_identifier = '19,';

    /* * * DON'T EDIT BELOW THIS LINE * * */

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>



    </article>
    
    <script type="text/javascript">
        document.getElementById( 'top-post' ).scrollIntoView();
    </script>

</main>
            
        </div>
    </div>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']]
    }
  });
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-44365202-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</body>
</html>